name: 'Deploy to Cloud Run'

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["CI, build docker image and push that"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      # 1️⃣ 인증 먼저!
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CLOUR_RUN_ACCOUNT_KEY }}

      # 2️⃣ gcloud CLI 설치 (인증 안됨 주의)
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_NAME }}

      # 3️⃣ 이전 리비전 조회
      - name: Get previous revision
        id: previous
        run: |
          REVISION=$(gcloud run services describe knuclface-service \
            --region=asia-northeast3 \
            --format="value(status.traffic[0].revisionName)")
          echo "prev_revision=$REVISION" >> $GITHUB_OUTPUT

      # 4️⃣ Cloud Run 배포
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: knuclface-service
          image: asia-northeast3-docker.pkg.dev/${{ secrets.GCP_PROJECT_NAME }}/${{ secrets.GCP_AR_NAME }}/knuclface:latest
          region: asia-northeast3
          credentials: ${{ secrets.GCP_CLOUD_RUN_ACCOUNT_KEY }}

      # 5️⃣ 헬스체크
      - name: Wait for service to warm up
        run: sleep 10

      - name: Health check
        id: health
        continue-on-error: true
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://${{ steps.deploy.outputs.url }})
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      # 6️⃣ 롤백
      - name: Rollback if health check failed
        if: ${{ steps.health.outputs.status != '200' }}
        run: |
          echo "⚠️ Health check failed. Rolling back to previous revision: ${{ steps.previous.outputs.prev_revision }}"
          gcloud run services update-traffic knuclface-service \
            --region=asia-northeast3 \
            --to-revisions=${{ steps.previous.outputs.prev_revision }}=100
